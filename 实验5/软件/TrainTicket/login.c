#include "login.h"
#include "ticket.h"
void print_function()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                             火车自动售票系统                               │");
	printf("│----------------------------------------------------------------------------│");
	printf("│                      ->登入                                                │");
	printf("│                        注册                                                │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_price_search()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                             票价查询中心                                   │");
	printf("│----------------------------------------------------------------------------│");
	printf("│     出  发  站  点:                                                        │");
	printf("│                                                                            │");
	printf("│     到  达  站  点:                                                        │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_ticketnum()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                             余票查询中心                                   │");
	printf("│----------------------------------------------------------------------------│");
	printf("│   车次编号     出发时间       到达时间       历时         票价      余票   │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_price_info()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                             票价查询中心                                   │");
	printf("│----------------------------------------------------------------------------│");
	printf("│   车次编号   出发站    到达站     出发时间    到达时间     历时     票价   │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_price_searchtrn()
{	
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                             票价查询中心                                   │");
	printf("│----------------------------------------------------------------------------│");
	printf("│   车次编号 出发站  到达站  出发时间  到达时间         历时          票价   │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");

}
void print_login()
{
	system("cls");
    printf("┌──────────────────────────────────────┐");
	printf("│                              用户登入界面                                  │");
	printf("│----------------------------------------------------------------------------│");
	printf("│                   用户名:                                                  │");
	printf("│                                                                            │");
	printf("│                   密  码:                                                  │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_register()
{
	system("cls");
    printf("┌──────────────────────────────────────┐");
	printf("│                              用户注册界面                                  │");
	printf("│----------------------------------------------------------------------------│");
	printf("│               用  户  名:                                                  │");
	printf("│                                                                            │");
	printf("│               密      码:                                                  │");
	printf("│                                                                            │");
	printf("│               确认  密码:                                                  │");
	printf("│                                                                            │");
	printf("│               身份证号码:                                                  │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│   确认[Enter]                                           退出[Esc]          │");
	printf("└──────────────────────────────────────┘");
}
void print_admin()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                             火车自动售票系统                               │");
	printf("│----------------------------------------------------------------------------│");
	printf("│                      ->站点管理                                            │");
	printf("│                        车次管理                                            │");
	printf("│                        票务管理                                            │");
	printf("│                        注销                                                │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_passenger()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                             火车自动售票系统                               │");
	printf("│----------------------------------------------------------------------------│");
	printf("│                      ->站点查询                                            │");
	printf("│                        票价查询                                            │");
	printf("│                        余票查询                                            │");
	printf("│                        购票                                                │");
	printf("│                        退票                                                │");
	printf("│                        我的12306                                           │");
	printf("│                        注销                                                │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_myservice()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                                我的12306                                   │");
	printf("│----------------------------------------------------------------------------│");
	printf("│                      ->密码修改                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void print_modify_pawd()
{
	system("cls");
	printf("┌──────────────────────────────────────┐");
	printf("│                                我的12306                                   │");
	printf("│----------------------------------------------------------------------------│");
	printf("│                  验证密码:                                                 │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│              输入新的密码:                                                 │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│          重新输入新的密码:                                                 │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│                                                                            │");
	printf("│  确认[Enter]                                           退出[Esc]           │");
	printf("└──────────────────────────────────────┘");
}
void admin_function()
{
	int get;
	while(1)
	{
		print_admin();
		get=modify_direction(24,3,6);
		switch(get)
		{
		case 3:
			{
				stt_function();
				break;
			}
		case 4:
			{
				trn_function();
				break;
			}
		case 5:
			{
				//票务尚未开通
				break;
			}
		case 6:
			{
				return;
			}
		case 27:
			{
				gotoXY(20,20);
				exit(1);
			}
		default :
			{
				break;
			}
		}
	}
}
void passenger_function(char*acname)
{
	time_t ticks;
	struct tm *t;
	int get;
	FILE*stt_fp;
	LIST_T*stt_head;
	char date[20];
	ticks=time(NULL);
	t= localtime(&ticks);
	strftime(date,127,"%Y-%m-%d %H:%M:%S",t);
	stt_head=list_init();
	stt_fp=file_open("station.txt");
	file_readall(stt_fp,stt_head,ISTT);
	while(1)
	{
		print_passenger();
		get=modify_direction(24,3,9);
		switch(get)
		{
		case 3:
			{
				pasg_stt_search(stt_head);
				break;
			}
		case 4:
			{
				price_search();
				break;
			}
		case 5://余票查询
			{
				ticket_search(t);
				break;
			}
		case 6://购票
			{
				ticket_buy(acname,t);//参数是用户名
				break;
			}
		case 7://退票
			{
				ticket_return(acname,t);
				break;
			}
		case 8:
			{
				user_myservice(acname);
				break;
			}
		case 9:
			{
				return;
			}
		case 27:
			{
				gotoXY(20,20);
				exit(1);
			}
		default :
			{
				break;
			}
		}
	}
}
void pasg_stt_search(LIST_T*head)
{
	char stt[11]=" ",filename[15]=" ",way_filename[15]=" ";
	int get,num;
	FILE*trn_fp,*way_fp,*stt_fp;
	LIST_T*trn_head,*way_head,*temp,*new_trn_head,*stt_head;
	TRN_T*data;
	WAY_T*way_data;
	trn_head=list_init();
	stt_head=list_init();
	new_trn_head=list_init();
	way_head=list_init();
	trn_fp=file_open("train.txt");
	stt_fp=file_open("station.txt");
	file_readall(trn_fp,trn_head,ITRN);
	file_readall(stt_fp,stt_head,ISTT);
	print_stt_search();
	while (1)
	{
		
		gotoXY(28,3);
		get=glb_putString(stt,4,10,1);
		if(get==27)
		{
			return;
		}
		if (list_search_name(stt,stt_head,stt_namematch)==NULL)
		{
			gotoXY(10,10);
			printf("没有该站点");
			Sleep(1000);
			gotoXY(10,10);
			printf("          ");
			gotoXY(28,3);
			printf("              ");
			continue;
		}
		break;
	}
	temp=trn_head;
	while(temp->pnext!=NULL)
	{
		temp=temp->pnext;
		sprintf(filename,"%s.txt",((TRN_T*)(temp->data))->id);//获取id得到文件名
		way_fp=file_open(filename);
		file_readall(way_fp,way_head,IWAY);//读取文件信息存到
		data=list_search_name(stt,way_head,way_sttmatch);//返回trnt型数据
		if(data==NULL)
		{
			continue;
		}
		//list_add(new_trn_head,temp->data);
		list_add_count(new_trn_head,trn_ftimematch(new_trn_head,temp->data),temp->data);

	}
	num=trn_printpage(new_trn_head);//获取第几个节点然后传参数到way_info
	if(num==0)
	{
		return ;
	}
	free(way_head);
	way_head=list_init();
	way_data=list_search_count(num,new_trn_head);
	sprintf(way_filename,"%s.txt",way_data->id);
	way_fp=file_open(way_filename);
	file_readall(way_fp,way_head,IWAY);
	way_printpage(way_head);
	fclose(way_fp);
	free(new_trn_head);
}
int trn_ftimematch(LIST_T*head,TRN_T*data)
{
	int i=0;
	LIST_T*temp=head;
	if (list_count(head)==0)
		return 0;
	{
	}
	while(temp->pnext!=NULL)
	{
		temp=temp->pnext;
		i++;
		if(trn_usetime(((TRN_T*)(temp->data))->btime,data->btime)<0)
		{
			return i-1;
		}
	}
	return i;
} 
LIST_T* ticket_match(char*fstt,char*lstt,LIST_T*way_head,LIST_T*trn_head)
{
	char filename[15]=" ";
	FILE*way_fp;
	int i=0;
	LIST_T*temp=trn_head,*new_head;
	WAY_T*fdata,*ldata;
	TRN_T*trn_data;
	new_head=list_init();
	while(temp->pnext!=NULL)
	{
		temp=temp->pnext;
		sprintf(filename,"%s.txt",((TRN_T*)(temp->data))->id);//获取id得到文件名
		way_fp=file_open(filename);
		memset(way_head,0,ILIST);
		file_readall(way_fp,way_head,IWAY);//读取文件信息存到
		fdata=list_search_name(fstt,way_head,way_sttmatchdim);
		ldata=list_search_name(lstt,way_head,way_sttmatchdim);
		if(ldata==NULL||fdata==NULL)
		{
			continue;
		}
		if((ldata->price)<=(fdata->price))
		{
			continue;
		}
		else//找到两点加入链表
		{
			i++;
			trn_data=(TRN_T*)malloc(ITRN);
			memset(trn_data,0,ITRN);
			strcpy(trn_data->id,fdata->id);
		    strcpy(trn_data->btime,fdata->etime);
			strcpy(trn_data->etime,ldata->btime);
			strcpy(trn_data->fstt,fdata->stt);
			strcpy(trn_data->lstt,ldata->stt);
			trn_data->distance=ldata->distance-fdata->distance;
			list_add(new_head,trn_data);
		}
		memset(way_head,0,ILIST);//重新赋值为0重新读入
	}
	if(i==0)
	{
		return NULL;
	}
	return new_head;
}

void  price_printpage_nosearch(LIST_T*head)
{
	int i=1;//从第一页开始算
	int num;
	int ikey;
	while(1)
	{
		system("cls");
		print_price_info();
		gotoXY(0,4);
		num=list_print_page(head,i,5,price_printone);
		if(num==0)
		{
			gotoXY(27,6);
			printf("尚未添加车次");
			Sleep(1000);
			gotoXY(15,20);
			printf("            ");
			return;
		}
		while(1)
		{
			ikey= glb_putDirection();
			if(ikey==27)
			{
				return ;//0表示没有用户不想操作 退出该模块 
			}
			if (ikey==75)
			{
				if (i!=1)
				{
					i-=1;
					break;
				}
				else
				{
					system("cls");
					printf("已经是第一页");
					system("pause");
					break;
				}
			}
			if (ikey==77)
			{
				//此处添加一个判断个数的函数
				if(i*5>=list_count(head))
				{
					system("cls");
					printf("已经是最后一页");
					system("pause");
					break;
				}
				else
				{
					i++;
					break;
				}
			}	
		}
	}
}
void price_search()
{
	FILE*trn_fp;
	int i=0,get;//记录 有一个合适的车次
	LIST_T*trn_head,*temp,*way_head,*new_head;
	char fstt[11]=" ",lstt[11]=" ",filename[15]=" ";
	trn_fp=file_open("train.txt");
	trn_head=list_init();
	way_head=list_init();
	file_readall(trn_fp,trn_head,ITRN);
	temp=trn_head;
	print_price_search();
	gotoXY(22,3);
	get=glb_putString(fstt,4,10,1);
	if(get==27)
	{
		return;
	}
	gotoXY(22,5);
	get=glb_putString(lstt,4,10,1);
	if(get==27)
	{
		return;
	}
//	print_price_searchtrn();
	gotoXY(0,4);
	new_head=ticket_match(fstt,lstt,way_head,trn_head,price_printone);
	if(new_head==NULL)
	{
		gotoXY(20,20);
		printf("没有一条车次经过%s和%s",fstt,lstt);
		Sleep(1000);
	}
	else
	{
		price_printpage_nosearch(new_head);
		gotoXY(20,20);
		system("pause");
	}

}
int price_printone(TRN_T*data)
{
	int usetime;
	usetime=trn_usetime(data->btime,data->etime);
	printf("│%5s   %10s%10s      %3c%c:%c%c     %3c%c:%c%c     %0.2d:%0.2d    %6.2f\n"
		,data->id,data->fstt,data->lstt,data->btime[0],data->btime[1],data->btime[2],data->btime[3],
		data->etime[0],data->etime[1],data->etime[2],data->etime[3],usetime/60,usetime%60,data->distance*1.2);
	return 1;
}
void user_login(LIST_T*head)
{
	int get;
	char acname[11]=" ",acpwd[7]=" ";
	while (1)
	{
		print_login();
		gotoXY(29,3);
		get=glb_putString(acname,3,10,1);
		if(get==27)
		{
			return;
		}
		gotoXY(29,5);
		get=glb_putString(acpwd,1,6,0);
		if(get==27)
		{
			return;
		}
		if(strcmp(acname,"admin")==0&&strcmp(acpwd,"123456")==0)
		{
			gotoXY(20,11);
			printf("尊敬的管理员,欢迎登入");
			Sleep(800);
			admin_function();
		}
		else
		{
			if(list_login(head,acname,acpwd,user_loginok))
			{
				gotoXY(20,11);
			    printf("亲爱的旅客,欢迎登入");
				Sleep(800);
				passenger_function(acname);
			}
			else
			{
				gotoXY(20,11);
				printf("密码错误，重新输入");
				Sleep(1500);
				gotoXY(20,11);
				printf("                  ");
				gotoXY(29,3);
				printf("           ");
				gotoXY(29,5);
				printf("           ");
				continue;
			}
		}
	}
}
void user_register(LIST_T*head)
{
	int get,count;
	PSG_T*data;
	char temppwd[7]=" ";
	data=(PSG_T*)malloc(IPSG);
	memset(data,0,IPSG);
	print_register();
	while (1)
	{
		gotoXY(29,3);
		printf("             ");
		gotoXY(29,3);
		get=glb_putString(data->name,3,10,1);
		if(get==27)
		{
			free(data);
			return;
		}
		if(list_search_name(data->name,head,user_namemacth)!=NULL||strcmp(data->name,"admin")==0)//不是NULL说明已经有相同的名字
		{
			gotoXY(20,11);
			printf("已经存在相同的用户名，请重新输入");
			Sleep(1000);
			gotoXY(20,11);
			printf("                                ");
		}
		else
		{
			break;
		}
	}
	while(1)
	{
		gotoXY(29,5);
		printf("             ");
		gotoXY(29,7);
		printf("             ");
		gotoXY(29,5);
		get=glb_putString(data->pawd,1,6,0);
		if(get==27)
		{
			free(data);
			return;
		}
		gotoXY(29,7);
		get=glb_putString(temppwd,1,6,0);
		if(get==27)
		{
			free(data);
			return;
		}
		if(strcmp(temppwd,data->pawd)==0)
		{
			break;
		}
		else
		{
			gotoXY(10,11);
			printf("验证密码失败，请输入两次相同的密码");
			Sleep(1000);
			gotoXY(10,11);
			printf("                                          ");
		}
	}
	while (1)
	{
		gotoXY(29,9);
		printf("                                   ");
		gotoXY(29,9);
		get=glb_putString(data->id,1,18,1);
		if(get==27)
		{
			free(data);
			return;
		}
		if(user_id(data->id,head)!=0)
		{
			break;
		}
		else
		{
			gotoXY(10,11);
			printf("请输入合法的身份证号，请勿重复使用身份证号");
			Sleep(1000);
			gotoXY(10,11);
			printf("                                          ");
		}
	}
	count=list_count(head);
	if(count==0)
	{
		data->no=1;
	}
	else
	{
		data->no=((PSG_T*)(list_search_count(count,head)))->no+1;
	}
	list_add(head,data);
	gotoXY(28,11);
	printf("添加旅客成功");
	Sleep(1000);
}

void user_function()
{
	int get;
	LIST_T*user_head;
	FILE*user_fp;
	
	while(1)
	{
		user_fp=file_open("user.txt");
		user_head=list_init();
    	file_readall(user_fp,user_head,IPSG);
		print_function();
		get=modify_direction(24,3,4);
		switch(get)
		{
		case 3:
			{
				user_login(user_head);
				break;
			}
		case 4:
			{
				user_register(user_head);
				file_writeall(user_head,IPSG,"user.txt");
				break;
			}
		case 27:
			{
				file_writeall(user_head,IPSG,"user.txt");
				gotoXY(0,20);
				exit(0);
			}
		default :
			{
				break;
			}
		}
	}
}

int user_namemacth(char*name,void*data)
{
	if(strcmp(name,((PSG_T*)(data))->name)==0)
	{
		return 1;
	}
	else return 0;
}
int user_loginok(char *name,char*pawd,void*data)
{
	if(strcmp(name,((PSG_T*)(data))->name)==0&&strcmp(pawd,((PSG_T*)(data))->pawd)==0)
		return 1;
	else 
		return 0;
}

int user_idmatch(char *id,void *data)
{
	if(strcmp(((PSG_T*)(data))->id,id)==0)
		return 1;
	else 
		return 0;
}

int user_id(char* id,LIST_T*head)
{
	if(strlen(id)!=18)
		return 0;
	if(list_search_name(id,head,user_idmatch)==NULL)
	{
		return 1;
	}
	else 
		return 0;
}

void user_myservice(char*acname)
{
	int get;
	while(1)
	{

		print_myservice();
		get=modify_direction(24,3,3);
		switch(get)
		{
		case 3:
			{
				user_modify_pawd(acname);
				break;
			}
		case 27:
			{
				return;
			}
		default :
			{
				break;
			}
		}
	}
}
void user_modify_pawd(char*acname)
{
	FILE*user_fp;
	PSG_T*data;
	char pawd[7]=" ",pawdtemp[7]=" ";
	LIST_T*user_head;
	int get;
	user_head=list_init();
	user_fp=file_open("user.txt");
	file_readall(user_fp,user_head,IPSG);
	data=list_search_name(acname,user_head,user_namemacth);
	print_modify_pawd();
	while(1)
	{
		gotoXY(29,3);
		get=glb_putString(pawd,1,6,0);
		if(get==27)
		{
			return;
		}
		if (strcmp(pawd,data->pawd)==0)
		{
			break;
		}
		else
		{
			gotoXY(20,12);
			printf("请再次输入您原来的密码");
			Sleep(1000);
			gotoXY(20,12);
			printf("                      ");
			gotoXY(29,3);
			printf("              ");
		}
	}
	while(1)
	{
		gotoXY(29,6);
		get=glb_putString(pawd,1,6,0);
		if (get==27)
		{
			return ;
		}
		gotoXY(29,9);
		get=glb_putString(pawdtemp,1,6,0);
		if (get==27)
		{
			return;
		}
		if(strcmp(pawd,pawdtemp)==0)
		{
			break;
		}
		else
		{
			gotoXY(20,12);
			printf("请输入两次相同的密码");
			Sleep(1000);
			gotoXY(20,12);
			printf("                      ");
			gotoXY(29,6);
			printf("              ");
			gotoXY(29,9);
			printf("              ");
		}
	}
	strcpy(data->pawd,pawdtemp);
	file_writeall(user_head,IPSG,"user.txt");
	gotoXY(20,12);
	printf("修改成功！");
	Sleep(1000);
}